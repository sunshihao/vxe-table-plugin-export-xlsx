"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginExportXLSX = void 0;
var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));
var _xlsx = _interopRequireDefault(require("xlsx"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }
/* eslint-disable no-unused-vars */

/* eslint-enable no-unused-vars */
var _vxetable;
function getCellLabel(column, cellValue) {
  if (cellValue) {
    switch (column.cellType) {
      case 'string':
        return _xeUtils["default"].toValueString(cellValue);
      case 'number':
        if (!isNaN(cellValue)) {
          return Number(cellValue);
        }
        break;
      default:
        if (cellValue.length < 12 && !isNaN(cellValue)) {
          return Number(cellValue);
        }
        break;
    }
  }
  return cellValue;
}
function getFooterCellValue($table, opts, rows, column) {
  var cellValue = _xeUtils["default"].toString(rows[$table.$getColumnIndex(column)]);
  return cellValue;
}
function toBuffer(wbout) {
  var buf = new ArrayBuffer(wbout.length);
  var view = new Uint8Array(buf);
  for (var index = 0; index !== wbout.length; ++index) {
    view[index] = wbout.charCodeAt(index) & 0xFF;
  }
  return buf;
}
function exportXLSX(params) {
  var $table = params.$table,
    options = params.options,
    columns = params.columns,
    datas = params.datas;
  var sheetName = options.sheetName,
    isHeader = options.isHeader,
    isFooter = options.isFooter,
    original = options.original,
    message = options.message,
    footerFilterMethod = options.footerFilterMethod;
  var colHead = {};
  var footList = [];
  // const rowList = datas
  if (isHeader) {
    columns.forEach(function (column) {
      colHead[column.id] = _xeUtils["default"].toString(original ? column.property : column.getTitle());
    });
  }
  // 新增部分
  var rowList = datas.map(function (item) {
    var rest = {};
    columns.forEach(function (column) {
      rest[column.id] = getCellLabel(column, item[column.id]);
    });
    return rest;
  });
  if (isFooter) {
    var _$table$getTableData = $table.getTableData(),
      footerData = _$table$getTableData.footerData;
    var footers = footerFilterMethod ? footerData.filter(footerFilterMethod) : footerData;
    footers.forEach(function (rows) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = getFooterCellValue($table, options, rows, column);
      });
      footList.push(item);
    });
  }
  var book = _xlsx["default"].utils.book_new();
  var sheet = _xlsx["default"].utils.json_to_sheet((isHeader ? [colHead] : []).concat(rowList).concat(footList), {
    skipHeader: true
  });
  // 转换数据
  _xlsx["default"].utils.book_append_sheet(book, sheet, sheetName);
  var wbout = _xlsx["default"].write(book, {
    bookType: 'xlsx',
    bookSST: false,
    type: 'binary'
  });
  var blob = new Blob([toBuffer(wbout)], {
    type: 'application/octet-stream'
  });
  // 保存导出
  downloadFile(blob, options);
  if (message !== false) {
    _vxetable.modal.message({
      message: _vxetable.t('vxe.table.expSuccess'),
      status: 'success'
    });
  }
}
function downloadFile(blob, options) {
  if (window.Blob) {
    var filename = options.filename,
      type = options.type;
    if (navigator.msSaveBlob) {
      navigator.msSaveBlob(blob, "".concat(filename, ".").concat(type));
    } else {
      var linkElem = document.createElement('a');
      linkElem.target = '_blank';
      linkElem.download = "".concat(filename, ".").concat(type);
      linkElem.href = URL.createObjectURL(blob);
      document.body.appendChild(linkElem);
      linkElem.click();
      document.body.removeChild(linkElem);
    }
  } else {
    console.error(_vxetable.t('vxe.error.notExp'));
  }
}
function replaceDoubleQuotation(val) {
  return val.replace(/^"/, '').replace(/"$/, '');
}
function parseCsv(columns, content) {
  var list = content.split('\n');
  var fields = [];
  var rows = [];
  if (list.length) {
    var rList = list.slice(1);
    list[0].split(',').map(replaceDoubleQuotation);
    rList.forEach(function (r) {
      if (r) {
        var item = {};
        r.split(',').forEach(function (val, colIndex) {
          if (fields[colIndex]) {
            item[fields[colIndex]] = replaceDoubleQuotation(val);
          }
        });
        rows.push(item);
      }
    });
  }
  return {
    fields: fields,
    rows: rows
  };
}
function checkImportData(columns, fields, rows) {
  var tableFields = [];
  columns.forEach(function (column) {
    var field = column.property;
    if (field) {
      tableFields.push(field);
    }
  });
  return tableFields.every(function (field) {
    return fields.includes(field);
  });
}
function importXLSX(params) {
  var columns = params.columns,
    options = params.options,
    file = params.file;
  var $table = params.$table;
  var _importResolve = $table._importResolve;
  var fileReader = new FileReader();
  fileReader.onload = function (e) {
    var workbook = _xlsx["default"].read(e.target.result, {
      type: 'binary'
    });
    var csvData = _xlsx["default"].utils.sheet_to_csv(workbook.Sheets.Sheet1);
    var _parseCsv = parseCsv(columns, csvData),
      fields = _parseCsv.fields,
      rows = _parseCsv.rows;
    var status = checkImportData(columns, fields, rows);
    if (status) {
      $table.createData(rows).then(function (data) {
        if (options.mode === 'append') {
          $table.insertAt(data, -1);
        } else {
          $table.reloadData(data);
        }
      });
      if (options.message !== false) {
        _vxetable.modal.message({
          message: _xeUtils["default"].template(_vxetable.t('vxe.table.impSuccess'), [rows.length]),
          status: 'success'
        });
      }
    } else if (options.message !== false) {
      _vxetable.modal.message({
        message: _vxetable.t('vxe.error.impFields'),
        status: 'error'
      });
    }
    if (_importResolve) {
      _importResolve(status);
      $table._importResolve = null;
    }
  };
  fileReader.readAsBinaryString(file);
}
function handleImportEvent(params) {
  if (params.options.type === 'xlsx') {
    importXLSX(params);
    return false;
  }
}
function handleExportEvent(params) {
  if (params.options.type === 'xlsx') {
    exportXLSX(params);
    return false;
  }
}
/**
 * 基于 vxe-table 表格的增强插件，支持导出 xlsx 格式
 */
var VXETablePluginExportXLSX = {
  install: function install(xtable) {
    var interceptor = xtable.interceptor;
    _vxetable = xtable;
    Object.assign(xtable.types, {
      xlsx: 1
    });
    interceptor.mixin({
      'event.import': handleImportEvent,
      'event.export': handleExportEvent
    });
  }
};
exports.VXETablePluginExportXLSX = VXETablePluginExportXLSX;
if (typeof window !== 'undefined' && window.VXETable) {
  window.VXETable.use(VXETablePluginExportXLSX);
}
var _default = VXETablePluginExportXLSX;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIiwiaW5kZXguanMiXSwibmFtZXMiOlsiX3Z4ZXRhYmxlIiwiZ2V0Q2VsbExhYmVsIiwiY29sdW1uIiwiY2VsbFZhbHVlIiwiY2VsbFR5cGUiLCJYRVV0aWxzIiwidG9WYWx1ZVN0cmluZyIsImlzTmFOIiwiTnVtYmVyIiwibGVuZ3RoIiwiZ2V0Rm9vdGVyQ2VsbFZhbHVlIiwiJHRhYmxlIiwib3B0cyIsInJvd3MiLCJ0b1N0cmluZyIsIiRnZXRDb2x1bW5JbmRleCIsInRvQnVmZmVyIiwid2JvdXQiLCJidWYiLCJBcnJheUJ1ZmZlciIsInZpZXciLCJVaW50OEFycmF5IiwiaW5kZXgiLCJjaGFyQ29kZUF0IiwiZXhwb3J0WExTWCIsInBhcmFtcyIsIm9wdGlvbnMiLCJjb2x1bW5zIiwiZGF0YXMiLCJzaGVldE5hbWUiLCJpc0hlYWRlciIsImlzRm9vdGVyIiwib3JpZ2luYWwiLCJtZXNzYWdlIiwiZm9vdGVyRmlsdGVyTWV0aG9kIiwiY29sSGVhZCIsImZvb3RMaXN0IiwiZm9yRWFjaCIsImlkIiwicHJvcGVydHkiLCJnZXRUaXRsZSIsInJvd0xpc3QiLCJtYXAiLCJpdGVtIiwicmVzdCIsImdldFRhYmxlRGF0YSIsImZvb3RlckRhdGEiLCJmb290ZXJzIiwiZmlsdGVyIiwicHVzaCIsImJvb2siLCJYTFNYIiwidXRpbHMiLCJib29rX25ldyIsInNoZWV0IiwianNvbl90b19zaGVldCIsImNvbmNhdCIsInNraXBIZWFkZXIiLCJib29rX2FwcGVuZF9zaGVldCIsIndyaXRlIiwiYm9va1R5cGUiLCJib29rU1NUIiwidHlwZSIsImJsb2IiLCJCbG9iIiwiZG93bmxvYWRGaWxlIiwibW9kYWwiLCJ0Iiwic3RhdHVzIiwid2luZG93IiwiZmlsZW5hbWUiLCJuYXZpZ2F0b3IiLCJtc1NhdmVCbG9iIiwibGlua0VsZW0iLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJ0YXJnZXQiLCJkb3dubG9hZCIsImhyZWYiLCJVUkwiLCJjcmVhdGVPYmplY3RVUkwiLCJib2R5IiwiYXBwZW5kQ2hpbGQiLCJjbGljayIsInJlbW92ZUNoaWxkIiwiY29uc29sZSIsImVycm9yIiwicmVwbGFjZURvdWJsZVF1b3RhdGlvbiIsInZhbCIsInJlcGxhY2UiLCJwYXJzZUNzdiIsImNvbnRlbnQiLCJsaXN0Iiwic3BsaXQiLCJmaWVsZHMiLCJyTGlzdCIsInNsaWNlIiwiciIsImNvbEluZGV4IiwiY2hlY2tJbXBvcnREYXRhIiwidGFibGVGaWVsZHMiLCJmaWVsZCIsImV2ZXJ5IiwiaW5jbHVkZXMiLCJpbXBvcnRYTFNYIiwiZmlsZSIsIl9pbXBvcnRSZXNvbHZlIiwiZmlsZVJlYWRlciIsIkZpbGVSZWFkZXIiLCJvbmxvYWQiLCJlIiwid29ya2Jvb2siLCJyZWFkIiwicmVzdWx0IiwiY3N2RGF0YSIsInNoZWV0X3RvX2NzdiIsIlNoZWV0cyIsIlNoZWV0MSIsImNyZWF0ZURhdGEiLCJ0aGVuIiwiZGF0YSIsIm1vZGUiLCJpbnNlcnRBdCIsInJlbG9hZERhdGEiLCJ0ZW1wbGF0ZSIsInJlYWRBc0JpbmFyeVN0cmluZyIsImhhbmRsZUltcG9ydEV2ZW50IiwiaGFuZGxlRXhwb3J0RXZlbnQiLCJWWEVUYWJsZVBsdWdpbkV4cG9ydFhMU1giLCJpbnN0YWxsIiwieHRhYmxlIiwiaW50ZXJjZXB0b3IiLCJPYmplY3QiLCJhc3NpZ24iLCJ0eXBlcyIsInhsc3giLCJtaXhpbiIsIlZYRVRhYmxlIiwidXNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQTtBQVNBO0FBQXVCO0FBVnZCOztBQVdBO0FBRUEsSUFBSUEsU0FBMEI7QUFHOUIsU0FBU0MsWUFBWSxDQUFFQyxNQUFvQixFQUFFQyxTQUFjLEVBQUE7RUFDekQsSUFBSUEsU0FBUyxFQUFFO0lBQ2IsUUFBUUQsTUFBTSxDQUFDRSxRQUFRO01BQ3JCLEtBQUssUUFBUTtRQUNYLE9BQU9DLG1CQUFPLENBQUNDLGFBQWEsQ0FBQ0gsU0FBUyxDQUFDO01BQ3pDLEtBQUssUUFBUTtRQUNYLElBQUksQ0FBQ0ksS0FBSyxDQUFDSixT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QUFHLENBQUNWLHdCQUF3QixDQUFDO0FDdEIvQztBRHVCQyxlQUVjQSx3QkFBd0I7QUFBQSIsImZpbGUiOiJpbmRleC5jb21tb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby11bnVzZWQtdmFycyAqL1xyXG5pbXBvcnQgWEVVdGlscyBmcm9tICd4ZS11dGlscy9tZXRob2RzL3hlLXV0aWxzJ1xyXG5pbXBvcnQge1xyXG4gIFZYRVRhYmxlLFxyXG4gIFRhYmxlLFxyXG4gIEludGVyY2VwdG9yRXhwb3J0UGFyYW1zLFxyXG4gIEludGVyY2VwdG9ySW1wb3J0UGFyYW1zLFxyXG4gIENvbHVtbkNvbmZpZyxcclxuICBFeHBvcnRPcHRvbnNcclxufSBmcm9tICd2eGUtdGFibGUvbGliL3Z4ZS10YWJsZSdcclxuaW1wb3J0IFhMU1ggZnJvbSAneGxzeCdcclxuLyogZXNsaW50LWVuYWJsZSBuby11bnVzZWQtdmFycyAqL1xyXG5cclxubGV0IF92eGV0YWJsZTogdHlwZW9mIFZYRVRhYmxlXHJcblxyXG5cclxuZnVuY3Rpb24gZ2V0Q2VsbExhYmVsIChjb2x1bW46IENvbHVtbkNvbmZpZywgY2VsbFZhbHVlOiBhbnkpIHtcclxuICBpZiAoY2VsbFZhbHVlKSB7XHJcbiAgICBzd2l0Y2ggKGNvbHVtbi5jZWxsVHlwZSkge1xyXG4gICAgICBjYXNlICdzdHJpbmcnOlxyXG4gICAgICAgIHJldHVybiBYRVV0aWxzLnRvVmFsdWVTdHJpbmcoY2VsbFZhbHVlKVxyXG4gICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgIGlmICghaXNOYU4oY2VsbFZhbHVlKSkge1xyXG4gICAgICAgICAgcmV0dXJuIE51bWJlcihjZWxsVmFsdWUpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGJyZWFrXHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgaWYgKGNlbGxWYWx1ZS5sZW5ndGggPCAxMiAmJiAhaXNOYU4oY2VsbFZhbHVlKSkge1xyXG4gICAgICAgICAgcmV0dXJuIE51bWJlcihjZWxsVmFsdWUpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGJyZWFrXHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBjZWxsVmFsdWVcclxufVxyXG5cclxuXHJcblxyXG5mdW5jdGlvbiBnZXRGb290ZXJDZWxsVmFsdWUgKCR0YWJsZTogVGFibGUsIG9wdHM6IEV4cG9ydE9wdG9ucywgcm93czogYW55W10sIGNvbHVtbjogQ29sdW1uQ29uZmlnKSB7XHJcbiAgdmFyIGNlbGxWYWx1ZSA9IFhFVXRpbHMudG9TdHJpbmcocm93c1skdGFibGUuJGdldENvbHVtbkluZGV4KGNvbHVtbildKVxyXG4gIHJldHVybiBjZWxsVmFsdWVcclxufVxyXG5cclxuZnVuY3Rpb24gdG9CdWZmZXIgKHdib3V0OiBhbnkpIHtcclxuICBsZXQgYnVmID0gbmV3IEFycmF5QnVmZmVyKHdib3V0Lmxlbmd0aClcclxuICBsZXQgdmlldyA9IG5ldyBVaW50OEFycmF5KGJ1ZilcclxuICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4ICE9PSB3Ym91dC5sZW5ndGg7ICsraW5kZXgpIHZpZXdbaW5kZXhdID0gd2JvdXQuY2hhckNvZGVBdChpbmRleCkgJiAweEZGXHJcbiAgcmV0dXJuIGJ1ZlxyXG59XHJcblxyXG5mdW5jdGlvbiBleHBvcnRYTFNYIChwYXJhbXM6IEludGVyY2VwdG9yRXhwb3J0UGFyYW1zKSB7XHJcbiAgY29uc3QgeyAkdGFibGUsIG9wdGlvbnMsIGNvbHVtbnMsIGRhdGFzIH0gPSBwYXJhbXNcclxuICBjb25zdCB7IHNoZWV0TmFtZSwgaXNIZWFkZXIsIGlzRm9vdGVyLCBvcmlnaW5hbCwgbWVzc2FnZSwgZm9vdGVyRmlsdGVyTWV0aG9kIH0gPSBvcHRpb25zXHJcbiAgY29uc3QgY29sSGVhZDogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9XHJcbiAgY29uc3QgZm9vdExpc3Q6IHsgW2tleTogc3RyaW5nXTogYW55IH1bXSA9IFtdXHJcbiAgLy8gY29uc3Qgcm93TGlzdCA9IGRhdGFzXHJcblxyXG4gIGlmIChpc0hlYWRlcikge1xyXG4gICAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW4pID0+IHtcclxuICAgICAgY29sSGVhZFtjb2x1bW4uaWRdID0gWEVVdGlscy50b1N0cmluZyhvcmlnaW5hbCA/IGNvbHVtbi5wcm9wZXJ0eSA6IGNvbHVtbi5nZXRUaXRsZSgpKVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIC8vIOaWsOWinumDqOWIhlxyXG4gIGNvbnN0IHJvd0xpc3QgPSBkYXRhcy5tYXAoaXRlbSA9PiB7XHJcbiAgICBjb25zdCByZXN0OiBhbnkgPSB7fVxyXG4gICAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW4pID0+IHtcclxuICAgICAgcmVzdFtjb2x1bW4uaWRdID0gZ2V0Q2VsbExhYmVsKGNvbHVtbiwgaXRlbVtjb2x1bW4uaWRdKVxyXG4gICAgfSlcclxuICAgIHJldHVybiByZXN0XHJcbiAgfSlcclxuXHJcbiAgaWYgKGlzRm9vdGVyKSB7XHJcbiAgICBjb25zdCB7IGZvb3RlckRhdGEgfSA9ICR0YWJsZS5nZXRUYWJsZURhdGEoKVxyXG4gICAgY29uc3QgZm9vdGVycyA9IGZvb3RlckZpbHRlck1ldGhvZCA/IGZvb3RlckRhdGEuZmlsdGVyKGZvb3RlckZpbHRlck1ldGhvZCkgOiBmb290ZXJEYXRhXHJcbiAgICBmb290ZXJzLmZvckVhY2goKHJvd3MpID0+IHtcclxuICAgICAgY29uc3QgaXRlbTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9XHJcbiAgICAgIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uKSA9PiB7XHJcbiAgICAgICAgaXRlbVtjb2x1bW4uaWRdID0gZ2V0Rm9vdGVyQ2VsbFZhbHVlKCR0YWJsZSwgb3B0aW9ucywgcm93cywgY29sdW1uKVxyXG4gICAgICB9KVxyXG4gICAgICBmb290TGlzdC5wdXNoKGl0ZW0pXHJcbiAgICB9KVxyXG4gIH1cclxuICBjb25zdCBib29rID0gWExTWC51dGlscy5ib29rX25ldygpXHJcbiAgY29uc3Qgc2hlZXQgPSBYTFNYLnV0aWxzLmpzb25fdG9fc2hlZXQoKGlzSGVhZGVyID8gW2NvbEhlYWRdIDogW10pLmNvbmNhdChyb3dMaXN0KS5jb25jYXQoZm9vdExpc3QpLCB7IHNraXBIZWFkZXI6IHRydWUgfSlcclxuICAvLyDovazmjaLmlbDmja5cclxuICBYTFNYLnV0aWxzLmJvb2tfYXBwZW5kX3NoZWV0KGJvb2ssIHNoZWV0LCBzaGVldE5hbWUpXHJcbiAgY29uc3Qgd2JvdXQgPSBYTFNYLndyaXRlKGJvb2ssIHsgYm9va1R5cGU6ICd4bHN4JywgYm9va1NTVDogZmFsc2UsIHR5cGU6ICdiaW5hcnknIH0pXHJcbiAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFt0b0J1ZmZlcih3Ym91dCldLCB7IHR5cGU6ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nIH0pXHJcbiAgLy8g5L+d5a2Y5a+85Ye6XHJcbiAgZG93bmxvYWRGaWxlKGJsb2IsIG9wdGlvbnMpXHJcbiAgaWYgKG1lc3NhZ2UgIT09IGZhbHNlKSB7XHJcbiAgICBfdnhldGFibGUubW9kYWwubWVzc2FnZSh7IG1lc3NhZ2U6IF92eGV0YWJsZS50KCd2eGUudGFibGUuZXhwU3VjY2VzcycpLCBzdGF0dXM6ICdzdWNjZXNzJyB9KVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZG93bmxvYWRGaWxlIChibG9iOiBCbG9iLCBvcHRpb25zOiBFeHBvcnRPcHRvbnMpIHtcclxuICBpZiAod2luZG93LkJsb2IpIHtcclxuICAgIGNvbnN0IHsgZmlsZW5hbWUsIHR5cGUgfSA9IG9wdGlvbnNcclxuICAgIGlmIChuYXZpZ2F0b3IubXNTYXZlQmxvYikge1xyXG4gICAgICBuYXZpZ2F0b3IubXNTYXZlQmxvYihibG9iLCBgJHtmaWxlbmFtZX0uJHt0eXBlfWApXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB2YXIgbGlua0VsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJylcclxuICAgICAgbGlua0VsZW0udGFyZ2V0ID0gJ19ibGFuaydcclxuICAgICAgbGlua0VsZW0uZG93bmxvYWQgPSBgJHtmaWxlbmFtZX0uJHt0eXBlfWBcclxuICAgICAgbGlua0VsZW0uaHJlZiA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYilcclxuICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChsaW5rRWxlbSlcclxuICAgICAgbGlua0VsZW0uY2xpY2soKVxyXG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGxpbmtFbGVtKVxyXG4gICAgfVxyXG4gIH0gZWxzZSB7XHJcbiAgICBjb25zb2xlLmVycm9yKF92eGV0YWJsZS50KCd2eGUuZXJyb3Iubm90RXhwJykpXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiByZXBsYWNlRG91YmxlUXVvdGF0aW9uICh2YWw6IHN0cmluZykge1xyXG4gIHJldHVybiB2YWwucmVwbGFjZSgvXlwiLywgJycpLnJlcGxhY2UoL1wiJC8sICcnKVxyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZUNzdiAoY29sdW1uczogQ29sdW1uQ29uZmlnW10sIGNvbnRlbnQ6IHN0cmluZykge1xyXG4gIGNvbnN0IGxpc3QgPSBjb250ZW50LnNwbGl0KCdcXG4nKVxyXG4gIGNvbnN0IGZpZWxkczogc3RyaW5nW10gPSBbXVxyXG4gIGNvbnN0IHJvd3M6IGFueVtdID0gW11cclxuICBpZiAobGlzdC5sZW5ndGgpIHtcclxuICAgIGNvbnN0IHJMaXN0ID0gbGlzdC5zbGljZSgxKVxyXG4gICAgbGlzdFswXS5zcGxpdCgnLCcpLm1hcChyZXBsYWNlRG91YmxlUXVvdGF0aW9uKVxyXG4gICAgckxpc3QuZm9yRWFjaCgocikgPT4ge1xyXG4gICAgICBpZiAocikge1xyXG4gICAgICAgIGNvbnN0IGl0ZW06IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fVxyXG4gICAgICAgIHIuc3BsaXQoJywnKS5mb3JFYWNoKCh2YWwsIGNvbEluZGV4KSA9PiB7XHJcbiAgICAgICAgICBpZiAoZmllbGRzW2NvbEluZGV4XSkge1xyXG4gICAgICAgICAgICBpdGVtW2ZpZWxkc1tjb2xJbmRleF1dID0gcmVwbGFjZURvdWJsZVF1b3RhdGlvbih2YWwpXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgICByb3dzLnB1c2goaXRlbSlcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcbiAgcmV0dXJuIHsgZmllbGRzLCByb3dzIH1cclxufVxyXG5cclxuZnVuY3Rpb24gY2hlY2tJbXBvcnREYXRhIChjb2x1bW5zOiBDb2x1bW5Db25maWdbXSwgZmllbGRzOiBzdHJpbmdbXSwgcm93czogYW55W10pIHtcclxuICBsZXQgdGFibGVGaWVsZHM6IHN0cmluZ1tdID0gW11cclxuICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbikgPT4ge1xyXG4gICAgbGV0IGZpZWxkID0gY29sdW1uLnByb3BlcnR5XHJcbiAgICBpZiAoZmllbGQpIHtcclxuICAgICAgdGFibGVGaWVsZHMucHVzaChmaWVsZClcclxuICAgIH1cclxuICB9KVxyXG4gIHJldHVybiB0YWJsZUZpZWxkcy5ldmVyeSgoZmllbGQpID0+IGZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGltcG9ydFhMU1ggKHBhcmFtczogSW50ZXJjZXB0b3JJbXBvcnRQYXJhbXMpIHtcclxuICBjb25zdCB7IGNvbHVtbnMsIG9wdGlvbnMsIGZpbGUgfSA9IHBhcmFtc1xyXG4gIGNvbnN0ICR0YWJsZTogYW55ID0gcGFyYW1zLiR0YWJsZVxyXG4gIGNvbnN0IHsgX2ltcG9ydFJlc29sdmUgfSA9ICR0YWJsZVxyXG4gIGNvbnN0IGZpbGVSZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpXHJcbiAgZmlsZVJlYWRlci5vbmxvYWQgPSAoZTogYW55KSA9PiB7XHJcbiAgICBjb25zdCB3b3JrYm9vayA9IFhMU1gucmVhZChlLnRhcmdldC5yZXN1bHQsIHsgdHlwZTogJ2JpbmFyeScgfSlcclxuICAgIGNvbnN0IGNzdkRhdGE6IHN0cmluZyA9IFhMU1gudXRpbHMuc2hlZXRfdG9fY3N2KHdvcmtib29rLlNoZWV0cy5TaGVldDEpXHJcbiAgICBjb25zdCB7IGZpZWxkcywgcm93cyB9ID0gcGFyc2VDc3YoY29sdW1ucywgY3N2RGF0YSlcclxuICAgIGNvbnN0IHN0YXR1cyA9IGNoZWNrSW1wb3J0RGF0YShjb2x1bW5zLCBmaWVsZHMsIHJvd3MpXHJcbiAgICBpZiAoc3RhdHVzKSB7XHJcbiAgICAgICR0YWJsZS5jcmVhdGVEYXRhKHJvd3MpXHJcbiAgICAgICAgLnRoZW4oKGRhdGE6IGFueVtdKSA9PiB7XHJcbiAgICAgICAgICBpZiAob3B0aW9ucy5tb2RlID09PSAnYXBwZW5kJykge1xyXG4gICAgICAgICAgICAkdGFibGUuaW5zZXJ0QXQoZGF0YSwgLTEpXHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAkdGFibGUucmVsb2FkRGF0YShkYXRhKVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgIGlmIChvcHRpb25zLm1lc3NhZ2UgIT09IGZhbHNlKSB7XHJcbiAgICAgICAgX3Z4ZXRhYmxlLm1vZGFsLm1lc3NhZ2UoeyBtZXNzYWdlOiBYRVV0aWxzLnRlbXBsYXRlKF92eGV0YWJsZS50KCd2eGUudGFibGUuaW1wU3VjY2VzcycpLCBbcm93cy5sZW5ndGhdKSwgc3RhdHVzOiAnc3VjY2VzcycgfSlcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChvcHRpb25zLm1lc3NhZ2UgIT09IGZhbHNlKSB7XHJcbiAgICAgIF92eGV0YWJsZS5tb2RhbC5tZXNzYWdlKHsgbWVzc2FnZTogX3Z4ZXRhYmxlLnQoJ3Z4ZS5lcnJvci5pbXBGaWVsZHMnKSwgc3RhdHVzOiAnZXJyb3InIH0pXHJcbiAgICB9XHJcbiAgICBpZiAoX2ltcG9ydFJlc29sdmUpIHtcclxuICAgICAgX2ltcG9ydFJlc29sdmUoc3RhdHVzKVxyXG4gICAgICAkdGFibGUuX2ltcG9ydFJlc29sdmUgPSBudWxsXHJcbiAgICB9XHJcbiAgfVxyXG4gIGZpbGVSZWFkZXIucmVhZEFzQmluYXJ5U3RyaW5nKGZpbGUpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUltcG9ydEV2ZW50IChwYXJhbXM6IEludGVyY2VwdG9ySW1wb3J0UGFyYW1zKSB7XHJcbiAgaWYgKHBhcmFtcy5vcHRpb25zLnR5cGUgPT09ICd4bHN4Jykge1xyXG4gICAgaW1wb3J0WExTWChwYXJhbXMpXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUV4cG9ydEV2ZW50IChwYXJhbXM6IEludGVyY2VwdG9yRXhwb3J0UGFyYW1zKSB7XHJcbiAgaWYgKHBhcmFtcy5vcHRpb25zLnR5cGUgPT09ICd4bHN4Jykge1xyXG4gICAgZXhwb3J0WExTWChwYXJhbXMpXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDln7rkuo4gdnhlLXRhYmxlIOihqOagvOeahOWinuW8uuaPkuS7tu+8jOaUr+aMgeWvvOWHuiB4bHN4IOagvOW8j1xyXG4gKi9cclxuZXhwb3J0IGNvbnN0IFZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWCA9IHtcclxuICBpbnN0YWxsICh4dGFibGU6IHR5cGVvZiBWWEVUYWJsZSkge1xyXG4gICAgY29uc3QgeyBpbnRlcmNlcHRvciB9ID0geHRhYmxlXHJcbiAgICBfdnhldGFibGUgPSB4dGFibGVcclxuICAgIE9iamVjdC5hc3NpZ24oeHRhYmxlLnR5cGVzLCB7IHhsc3g6IDEgfSlcclxuICAgIGludGVyY2VwdG9yLm1peGluKHtcclxuICAgICAgJ2V2ZW50LmltcG9ydCc6IGhhbmRsZUltcG9ydEV2ZW50LFxyXG4gICAgICAnZXZlbnQuZXhwb3J0JzogaGFuZGxlRXhwb3J0RXZlbnRcclxuICAgIH0pXHJcbiAgfVxyXG59XHJcblxyXG5pZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LlZYRVRhYmxlKSB7XHJcbiAgd2luZG93LlZYRVRhYmxlLnVzZShWWEVUYWJsZVBsdWdpbkV4cG9ydFhMU1gpXHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IFZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWFxyXG4iLCIvKiBlc2xpbnQtZGlzYWJsZSBuby11bnVzZWQtdmFycyAqL1xuaW1wb3J0IFhFVXRpbHMgZnJvbSAneGUtdXRpbHMvbWV0aG9kcy94ZS11dGlscyc7XG5pbXBvcnQgWExTWCBmcm9tICd4bHN4Jztcbi8qIGVzbGludC1lbmFibGUgbm8tdW51c2VkLXZhcnMgKi9cbmxldCBfdnhldGFibGU7XG5mdW5jdGlvbiBnZXRDZWxsTGFiZWwoY29sdW1uLCBjZWxsVmFsdWUpIHtcbiAgICBpZiAoY2VsbFZhbHVlKSB7XG4gICAgICAgIHN3aXRjaCAoY29sdW1uLmNlbGxUeXBlKSB7XG4gICAgICAgICAgICBjYXNlICdzdHJpbmcnOlxuICAgICAgICAgICAgICAgIHJldHVybiBYRVV0aWxzLnRvVmFsdWVTdHJpbmcoY2VsbFZhbHVlKTtcbiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XG4gICAgICAgICAgICAgICAgaWYgKCFpc05hTihjZWxsVmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBOdW1iZXIoY2VsbFZhbHVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIGlmIChjZWxsVmFsdWUubGVuZ3RoIDwgMTIgJiYgIWlzTmFOKGNlbGxWYWx1ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE51bWJlcihjZWxsVmFsdWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gY2VsbFZhbHVlO1xufVxuZnVuY3Rpb24gZ2V0Rm9vdGVyQ2VsbFZhbHVlKCR0YWJsZSwgb3B0cywgcm93cywgY29sdW1uKSB7XG4gICAgdmFyIGNlbGxWYWx1ZSA9IFhFVXRpbHMudG9TdHJpbmcocm93c1skdGFibGUuJGdldENvbHVtbkluZGV4KGNvbHVtbildKTtcbiAgICByZXR1cm4gY2VsbFZhbHVlO1xufVxuZnVuY3Rpb24gdG9CdWZmZXIod2JvdXQpIHtcbiAgICBsZXQgYnVmID0gbmV3IEFycmF5QnVmZmVyKHdib3V0Lmxlbmd0aCk7XG4gICAgbGV0IHZpZXcgPSBuZXcgVWludDhBcnJheShidWYpO1xuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggIT09IHdib3V0Lmxlbmd0aDsgKytpbmRleClcbiAgICAgICAgdmlld1tpbmRleF0gPSB3Ym91dC5jaGFyQ29kZUF0KGluZGV4KSAmIDB4RkY7XG4gICAgcmV0dXJuIGJ1Zjtcbn1cbmZ1bmN0aW9uIGV4cG9ydFhMU1gocGFyYW1zKSB7XG4gICAgY29uc3QgeyAkdGFibGUsIG9wdGlvbnMsIGNvbHVtbnMsIGRhdGFzIH0gPSBwYXJhbXM7XG4gICAgY29uc3QgeyBzaGVldE5hbWUsIGlzSGVhZGVyLCBpc0Zvb3Rlciwgb3JpZ2luYWwsIG1lc3NhZ2UsIGZvb3RlckZpbHRlck1ldGhvZCB9ID0gb3B0aW9ucztcbiAgICBjb25zdCBjb2xIZWFkID0ge307XG4gICAgY29uc3QgZm9vdExpc3QgPSBbXTtcbiAgICAvLyBjb25zdCByb3dMaXN0ID0gZGF0YXNcbiAgICBpZiAoaXNIZWFkZXIpIHtcbiAgICAgICAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW4pID0+IHtcbiAgICAgICAgICAgIGNvbEhlYWRbY29sdW1uLmlkXSA9IFhFVXRpbHMudG9TdHJpbmcob3JpZ2luYWwgPyBjb2x1bW4ucHJvcGVydHkgOiBjb2x1bW4uZ2V0VGl0bGUoKSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvLyDmlrDlop7pg6jliIZcbiAgICBjb25zdCByb3dMaXN0ID0gZGF0YXMubWFwKGl0ZW0gPT4ge1xuICAgICAgICBjb25zdCByZXN0ID0ge307XG4gICAgICAgIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uKSA9PiB7XG4gICAgICAgICAgICByZXN0W2NvbHVtbi5pZF0gPSBnZXRDZWxsTGFiZWwoY29sdW1uLCBpdGVtW2NvbHVtbi5pZF0pO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHJlc3Q7XG4gICAgfSk7XG4gICAgaWYgKGlzRm9vdGVyKSB7XG4gICAgICAgIGNvbnN0IHsgZm9vdGVyRGF0YSB9ID0gJHRhYmxlLmdldFRhYmxlRGF0YSgpO1xuICAgICAgICBjb25zdCBmb290ZXJzID0gZm9vdGVyRmlsdGVyTWV0aG9kID8gZm9vdGVyRGF0YS5maWx0ZXIoZm9vdGVyRmlsdGVyTWV0aG9kKSA6IGZvb3RlckRhdGE7XG4gICAgICAgIGZvb3RlcnMuZm9yRWFjaCgocm93cykgPT4ge1xuICAgICAgICAgICAgY29uc3QgaXRlbSA9IHt9O1xuICAgICAgICAgICAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW4pID0+IHtcbiAgICAgICAgICAgICAgICBpdGVtW2NvbHVtbi5pZF0gPSBnZXRGb290ZXJDZWxsVmFsdWUoJHRhYmxlLCBvcHRpb25zLCByb3dzLCBjb2x1bW4pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBmb290TGlzdC5wdXNoKGl0ZW0pO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgYm9vayA9IFhMU1gudXRpbHMuYm9va19uZXcoKTtcbiAgICBjb25zdCBzaGVldCA9IFhMU1gudXRpbHMuanNvbl90b19zaGVldCgoaXNIZWFkZXIgPyBbY29sSGVhZF0gOiBbXSkuY29uY2F0KHJvd0xpc3QpLmNvbmNhdChmb290TGlzdCksIHsgc2tpcEhlYWRlcjogdHJ1ZSB9KTtcbiAgICAvLyDovazmjaLmlbDmja5cbiAgICBYTFNYLnV0aWxzLmJvb2tfYXBwZW5kX3NoZWV0KGJvb2ssIHNoZWV0LCBzaGVldE5hbWUpO1xuICAgIGNvbnN0IHdib3V0ID0gWExTWC53cml0ZShib29rLCB7IGJvb2tUeXBlOiAneGxzeCcsIGJvb2tTU1Q6IGZhbHNlLCB0eXBlOiAnYmluYXJ5JyB9KTtcbiAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW3RvQnVmZmVyKHdib3V0KV0sIHsgdHlwZTogJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScgfSk7XG4gICAgLy8g5L+d5a2Y5a+85Ye6XG4gICAgZG93bmxvYWRGaWxlKGJsb2IsIG9wdGlvbnMpO1xuICAgIGlmIChtZXNzYWdlICE9PSBmYWxzZSkge1xuICAgICAgICBfdnhldGFibGUubW9kYWwubWVzc2FnZSh7IG1lc3NhZ2U6IF92eGV0YWJsZS50KCd2eGUudGFibGUuZXhwU3VjY2VzcycpLCBzdGF0dXM6ICdzdWNjZXNzJyB9KTtcbiAgICB9XG59XG5mdW5jdGlvbiBkb3dubG9hZEZpbGUoYmxvYiwgb3B0aW9ucykge1xuICAgIGlmICh3aW5kb3cuQmxvYikge1xuICAgICAgICBjb25zdCB7IGZpbGVuYW1lLCB0eXBlIH0gPSBvcHRpb25zO1xuICAgICAgICBpZiAobmF2aWdhdG9yLm1zU2F2ZUJsb2IpIHtcbiAgICAgICAgICAgIG5hdmlnYXRvci5tc1NhdmVCbG9iKGJsb2IsIGAke2ZpbGVuYW1lfS4ke3R5cGV9YCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB2YXIgbGlua0VsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7XG4gICAgICAgICAgICBsaW5rRWxlbS50YXJnZXQgPSAnX2JsYW5rJztcbiAgICAgICAgICAgIGxpbmtFbGVtLmRvd25sb2FkID0gYCR7ZmlsZW5hbWV9LiR7dHlwZX1gO1xuICAgICAgICAgICAgbGlua0VsZW0uaHJlZiA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmtFbGVtKTtcbiAgICAgICAgICAgIGxpbmtFbGVtLmNsaWNrKCk7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGxpbmtFbGVtKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihfdnhldGFibGUudCgndnhlLmVycm9yLm5vdEV4cCcpKTtcbiAgICB9XG59XG5mdW5jdGlvbiByZXBsYWNlRG91YmxlUXVvdGF0aW9uKHZhbCkge1xuICAgIHJldHVybiB2YWwucmVwbGFjZSgvXlwiLywgJycpLnJlcGxhY2UoL1wiJC8sICcnKTtcbn1cbmZ1bmN0aW9uIHBhcnNlQ3N2KGNvbHVtbnMsIGNvbnRlbnQpIHtcbiAgICBjb25zdCBsaXN0ID0gY29udGVudC5zcGxpdCgnXFxuJyk7XG4gICAgY29uc3QgZmllbGRzID0gW107XG4gICAgY29uc3Qgcm93cyA9IFtdO1xuICAgIGlmIChsaXN0Lmxlbmd0aCkge1xuICAgICAgICBjb25zdCByTGlzdCA9IGxpc3Quc2xpY2UoMSk7XG4gICAgICAgIGxpc3RbMF0uc3BsaXQoJywnKS5tYXAocmVwbGFjZURvdWJsZVF1b3RhdGlvbik7XG4gICAgICAgIHJMaXN0LmZvckVhY2goKHIpID0+IHtcbiAgICAgICAgICAgIGlmIChyKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaXRlbSA9IHt9O1xuICAgICAgICAgICAgICAgIHIuc3BsaXQoJywnKS5mb3JFYWNoKCh2YWwsIGNvbEluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChmaWVsZHNbY29sSW5kZXhdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtW2ZpZWxkc1tjb2xJbmRleF1dID0gcmVwbGFjZURvdWJsZVF1b3RhdGlvbih2YWwpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcm93cy5wdXNoKGl0ZW0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHsgZmllbGRzLCByb3dzIH07XG59XG5mdW5jdGlvbiBjaGVja0ltcG9ydERhdGEoY29sdW1ucywgZmllbGRzLCByb3dzKSB7XG4gICAgbGV0IHRhYmxlRmllbGRzID0gW107XG4gICAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW4pID0+IHtcbiAgICAgICAgbGV0IGZpZWxkID0gY29sdW1uLnByb3BlcnR5O1xuICAgICAgICBpZiAoZmllbGQpIHtcbiAgICAgICAgICAgIHRhYmxlRmllbGRzLnB1c2goZmllbGQpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHRhYmxlRmllbGRzLmV2ZXJ5KChmaWVsZCkgPT4gZmllbGRzLmluY2x1ZGVzKGZpZWxkKSk7XG59XG5mdW5jdGlvbiBpbXBvcnRYTFNYKHBhcmFtcykge1xuICAgIGNvbnN0IHsgY29sdW1ucywgb3B0aW9ucywgZmlsZSB9ID0gcGFyYW1zO1xuICAgIGNvbnN0ICR0YWJsZSA9IHBhcmFtcy4kdGFibGU7XG4gICAgY29uc3QgeyBfaW1wb3J0UmVzb2x2ZSB9ID0gJHRhYmxlO1xuICAgIGNvbnN0IGZpbGVSZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAgIGZpbGVSZWFkZXIub25sb2FkID0gKGUpID0+IHtcbiAgICAgICAgY29uc3Qgd29ya2Jvb2sgPSBYTFNYLnJlYWQoZS50YXJnZXQucmVzdWx0LCB7IHR5cGU6ICdiaW5hcnknIH0pO1xuICAgICAgICBjb25zdCBjc3ZEYXRhID0gWExTWC51dGlscy5zaGVldF90b19jc3Yod29ya2Jvb2suU2hlZXRzLlNoZWV0MSk7XG4gICAgICAgIGNvbnN0IHsgZmllbGRzLCByb3dzIH0gPSBwYXJzZUNzdihjb2x1bW5zLCBjc3ZEYXRhKTtcbiAgICAgICAgY29uc3Qgc3RhdHVzID0gY2hlY2tJbXBvcnREYXRhKGNvbHVtbnMsIGZpZWxkcywgcm93cyk7XG4gICAgICAgIGlmIChzdGF0dXMpIHtcbiAgICAgICAgICAgICR0YWJsZS5jcmVhdGVEYXRhKHJvd3MpXG4gICAgICAgICAgICAgICAgLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5tb2RlID09PSAnYXBwZW5kJykge1xuICAgICAgICAgICAgICAgICAgICAkdGFibGUuaW5zZXJ0QXQoZGF0YSwgLTEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgJHRhYmxlLnJlbG9hZERhdGEoZGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5tZXNzYWdlICE9PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgIF92eGV0YWJsZS5tb2RhbC5tZXNzYWdlKHsgbWVzc2FnZTogWEVVdGlscy50ZW1wbGF0ZShfdnhldGFibGUudCgndnhlLnRhYmxlLmltcFN1Y2Nlc3MnKSwgW3Jvd3MubGVuZ3RoXSksIHN0YXR1czogJ3N1Y2Nlc3MnIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKG9wdGlvbnMubWVzc2FnZSAhPT0gZmFsc2UpIHtcbiAgICAgICAgICAgIF92eGV0YWJsZS5tb2RhbC5tZXNzYWdlKHsgbWVzc2FnZTogX3Z4ZXRhYmxlLnQoJ3Z4ZS5lcnJvci5pbXBGaWVsZHMnKSwgc3RhdHVzOiAnZXJyb3InIH0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChfaW1wb3J0UmVzb2x2ZSkge1xuICAgICAgICAgICAgX2ltcG9ydFJlc29sdmUoc3RhdHVzKTtcbiAgICAgICAgICAgICR0YWJsZS5faW1wb3J0UmVzb2x2ZSA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIGZpbGVSZWFkZXIucmVhZEFzQmluYXJ5U3RyaW5nKGZpbGUpO1xufVxuZnVuY3Rpb24gaGFuZGxlSW1wb3J0RXZlbnQocGFyYW1zKSB7XG4gICAgaWYgKHBhcmFtcy5vcHRpb25zLnR5cGUgPT09ICd4bHN4Jykge1xuICAgICAgICBpbXBvcnRYTFNYKHBhcmFtcyk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG59XG5mdW5jdGlvbiBoYW5kbGVFeHBvcnRFdmVudChwYXJhbXMpIHtcbiAgICBpZiAocGFyYW1zLm9wdGlvbnMudHlwZSA9PT0gJ3hsc3gnKSB7XG4gICAgICAgIGV4cG9ydFhMU1gocGFyYW1zKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbn1cbi8qKlxuICog5Z+65LqOIHZ4ZS10YWJsZSDooajmoLznmoTlop7lvLrmj5Lku7bvvIzmlK/mjIHlr7zlh7ogeGxzeCDmoLzlvI9cbiAqL1xuZXhwb3J0IGNvbnN0IFZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWCA9IHtcbiAgICBpbnN0YWxsKHh0YWJsZSkge1xuICAgICAgICBjb25zdCB7IGludGVyY2VwdG9yIH0gPSB4dGFibGU7XG4gICAgICAgIF92eGV0YWJsZSA9IHh0YWJsZTtcbiAgICAgICAgT2JqZWN0LmFzc2lnbih4dGFibGUudHlwZXMsIHsgeGxzeDogMSB9KTtcbiAgICAgICAgaW50ZXJjZXB0b3IubWl4aW4oe1xuICAgICAgICAgICAgJ2V2ZW50LmltcG9ydCc6IGhhbmRsZUltcG9ydEV2ZW50LFxuICAgICAgICAgICAgJ2V2ZW50LmV4cG9ydCc6IGhhbmRsZUV4cG9ydEV2ZW50XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG5pZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LlZYRVRhYmxlKSB7XG4gICAgd2luZG93LlZYRVRhYmxlLnVzZShWWEVUYWJsZVBsdWdpbkV4cG9ydFhMU1gpO1xufVxuZXhwb3J0IGRlZmF1bHQgVlhFVGFibGVQbHVnaW5FeHBvcnRYTFNYO1xuIl19
