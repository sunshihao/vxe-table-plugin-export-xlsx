"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; return _typeof = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function (obj) { return typeof obj; } : function (obj) { return obj && "function" == typeof Symbol && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }, _typeof(obj); }
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginExportXLSX = void 0;
var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));
var XLSX = _interopRequireWildcard(require("xlsx-js-style"));
function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }
function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }
/* eslint-disable no-unused-vars */

// import XLSX from 'xlsx'

/* eslint-enable no-unused-vars */
var _vxetable;
function getCellLabel(column, cellValue) {
  if (cellValue) {
    switch (column.cellType) {
      case 'string':
        return _xeUtils["default"].toString(cellValue);
      case 'number':
        if (!isNaN(cellValue)) {
          return Number(cellValue);
        }
        break;
      default:
        if (cellValue.length < 12 && !isNaN(cellValue)) {
          return Number(cellValue);
        }
        break;
    }
  }
  return cellValue;
}
function getFooterCellValue($table, opts, rows, column) {
  var cellValue = _xeUtils["default"].toString(rows[$table.$getColumnIndex(column)]);
  return cellValue;
}
function toBuffer(wbout) {
  var buf = new ArrayBuffer(wbout.length);
  var view = new Uint8Array(buf);
  for (var index = 0; index !== wbout.length; ++index) {
    view[index] = wbout.charCodeAt(index) & 0xFF;
  }
  return buf;
}
function exportXLSX(params) {
  var $table = params.$table,
    options = params.options,
    columns = params.columns,
    datas = params.datas;
  var sheetName = options.sheetName,
    isHeader = options.isHeader,
    isFooter = options.isFooter,
    original = options.original,
    message = options.message,
    footerFilterMethod = options.footerFilterMethod;
  var colHead = {};
  var footList = [];
  // const rowList = datas
  if (isHeader) {
    columns.forEach(function (column) {
      colHead[column.id] = _xeUtils["default"].toString(original ? column.property : column.getTitle());
    });
  }
  // 新增部分
  var rowList = datas.map(function (item) {
    var rest = {};
    columns.forEach(function (column) {
      rest[column.id] = getCellLabel(column, item[column.id]);
    });
    return rest;
  });
  if (isFooter) {
    var _$table$getTableData = $table.getTableData(),
      footerData = _$table$getTableData.footerData;
    var footers = footerFilterMethod ? footerData.filter(footerFilterMethod) : footerData;
    footers.forEach(function (rows) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = getFooterCellValue($table, options, rows, column);
      });
      footList.push(item);
    });
  }
  var book = XLSX.utils.book_new();
  var sheet = XLSX.utils.json_to_sheet((isHeader ? [colHead] : []).concat(rowList).concat(footList), {
    skipHeader: true
  });
  Object.keys(sheet).forEach(function (key) {
    // 非!开头的属性都是单元格
    if (!key.startsWith('!')) {
      if (key.replace(/[^\d]/g, '') === '1') {
        sheet[key].v = sheet[key].v.padEnd(10, ' '); // 手动补位
        sheet[key].s = {
          font: {
            sz: '10',
            bold: true
          },
          fill: {
            fgColor: {
              rgb: 'F2F2F2'
            }
          },
          border: {
            top: {
              style: 'thin'
            },
            right: {
              style: 'thin'
            },
            bottom: {
              style: 'thin'
            },
            left: {
              style: 'thin'
            }
          }
        };
      } else {
        sheet[key].s = {
          font: {
            sz: '10'
          },
          alignment: {
            wrapText: true,
            vertical: 'top'
          },
          border: {
            top: {
              style: 'thin'
            },
            right: {
              style: 'thin'
            },
            bottom: {
              style: 'thin'
            },
            left: {
              style: 'thin'
            }
          }
        };
      }
    }
  });
  // 转换数据
  XLSX.utils.book_append_sheet(book, sheet, sheetName);
  var wbout = XLSX.write(book, {
    bookType: 'xlsx',
    bookSST: false,
    type: 'binary'
  });
  var blob = new Blob([toBuffer(wbout)], {
    type: 'application/octet-stream'
  });
  // 保存导出
  downloadFile(blob, options);
  if (message !== false) {
    _vxetable.modal.message({
      message: _vxetable.t('vxe.table.expSuccess'),
      status: 'success'
    });
  }
}
function downloadFile(blob, options) {
  if (window.Blob) {
    var filename = options.filename,
      type = options.type;
    if (navigator.msSaveBlob) {
      navigator.msSaveBlob(blob, "".concat(filename, ".").concat(type));
    } else {
      var linkElem = document.createElement('a');
      linkElem.target = '_blank';
      linkElem.download = "".concat(filename, ".").concat(type);
      linkElem.href = URL.createObjectURL(blob);
      document.body.appendChild(linkElem);
      linkElem.click();
      document.body.removeChild(linkElem);
    }
  } else {
    console.error(_vxetable.t('vxe.error.notExp'));
  }
}
function replaceDoubleQuotation(val) {
  return val.replace(/^"/, '').replace(/"$/, '');
}
function parseCsv(columns, content) {
  var list = content.split('\n');
  var fields = [];
  var rows = [];
  if (list.length) {
    var rList = list.slice(1);
    list[0].split(',').map(replaceDoubleQuotation);
    rList.forEach(function (r) {
      if (r) {
        var item = {};
        r.split(',').forEach(function (val, colIndex) {
          if (fields[colIndex]) {
            item[fields[colIndex]] = replaceDoubleQuotation(val);
          }
        });
        rows.push(item);
      }
    });
  }
  return {
    fields: fields,
    rows: rows
  };
}
function checkImportData(columns, fields, rows) {
  var tableFields = [];
  columns.forEach(function (column) {
    var field = column.property;
    if (field) {
      tableFields.push(field);
    }
  });
  return tableFields.every(function (field) {
    return fields.includes(field);
  });
}
function importXLSX(params) {
  var columns = params.columns,
    options = params.options,
    file = params.file;
  var $table = params.$table;
  var _importResolve = $table._importResolve;
  var fileReader = new FileReader();
  fileReader.onload = function (e) {
    var workbook = XLSX.read(e.target.result, {
      type: 'binary'
    });
    var csvData = XLSX.utils.sheet_to_csv(workbook.Sheets.Sheet1);
    var _parseCsv = parseCsv(columns, csvData),
      fields = _parseCsv.fields,
      rows = _parseCsv.rows;
    var status = checkImportData(columns, fields, rows);
    if (status) {
      $table.createData(rows).then(function (data) {
        if (options.mode === 'append') {
          $table.insertAt(data, -1);
        } else {
          $table.reloadData(data);
        }
      });
      if (options.message !== false) {
        _vxetable.modal.message({
          message: _xeUtils["default"].template(_vxetable.t('vxe.table.impSuccess'), [rows.length]),
          status: 'success'
        });
      }
    } else if (options.message !== false) {
      _vxetable.modal.message({
        message: _vxetable.t('vxe.error.impFields'),
        status: 'error'
      });
    }
    if (_importResolve) {
      _importResolve(status);
      $table._importResolve = null;
    }
  };
  fileReader.readAsBinaryString(file);
}
function handleImportEvent(params) {
  if (params.options.type === 'xlsx') {
    importXLSX(params);
    return false;
  }
}
function handleExportEvent(params) {
  if (params.options.type === 'xlsx') {
    exportXLSX(params);
    return false;
  }
}
/**
 * 基于 vxe-table 表格的增强插件，支持导出 xlsx 格式
 */
var VXETablePluginExportXLSX = {
  install: function install(xtable) {
    var interceptor = xtable.interceptor;
    _vxetable = xtable;
    Object.assign(xtable.types, {
      xlsx: 1
    });
    interceptor.mixin({
      'event.import': handleImportEvent,
      'event.export': handleExportEvent
    });
  }
};
exports.VXETablePluginExportXLSX = VXETablePluginExportXLSX;
if (typeof window !== 'undefined' && window.VXETable) {
  window.VXETable.use(VXETablePluginExportXLSX);
}
var _default = VXETablePluginExportXLSX;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIiwiaW5kZXguanMiXSwibmFtZXMiOlsiX3Z4ZXRhYmxlIiwiZ2V0Q2VsbExhYmVsIiwiY29sdW1uIiwiY2VsbFZhbHVlIiwiY2VsbFR5cGUiLCJYRVV0aWxzIiwidG9TdHJpbmciLCJpc05hTiIsIk51bWJlciIsImxlbmd0aCIsImdldEZvb3RlckNlbGxWYWx1ZSIsIiR0YWJsZSIsIm9wdHMiLCJyb3dzIiwiJGdldENvbHVtbkluZGV4IiwidG9CdWZmZXIiLCJ3Ym91dCIsImJ1ZiIsIkFycmF5QnVmZmVyIiwidmlldyIsIlVpbnQ4QXJyYXkiLCJpbmRleCIsImNoYXJDb2RlQXQiLCJleHBvcnRYTFNYIiwicGFyYW1zIiwib3B0aW9ucyIsImNvbHVtbnMiLCJkYXRhcyIsInNoZWV0TmFtZSIsImlzSGVhZGVyIiwiaXNGb290ZXIiLCJvcmlnaW5hbCIsIm1lc3NhZ2UiLCJmb290ZXJGaWx0ZXJNZXRob2QiLCJjb2xIZWFkIiwiZm9vdExpc3QiLCJmb3JFYWNoIiwiaWQiLCJwcm9wZXJ0eSIsImdldFRpdGxlIiwicm93TGlzdCIsIm1hcCIsIml0ZW0iLCJyZXN0IiwiZ2V0VGFibGVEYXRhIiwiZm9vdGVyRGF0YSIsImZvb3RlcnMiLCJmaWx0ZXIiLCJwdXNoIiwiYm9vayIsIlhMU1giLCJ1dGlscyIsImJvb2tfbmV3Iiwic2hlZXQiLCJqc29uX3RvX3NoZWV0IiwiY29uY2F0Iiwic2tpcEhlYWRlciIsIk9iamVjdCIsImtleXMiLCJrZXkiLCJzdGFydHNXaXRoIiwicmVwbGFjZSIsInYiLCJwYWRFbmQiLCJzIiwiZm9udCIsInN6IiwiYm9sZCIsImZpbGwiLCJmZ0NvbG9yIiwicmdiIiwiYm9yZGVyIiwidG9wIiwic3R5bGUiLCJyaWdodCIsImJvdHRvbSIsImxlZnQiLCJhbGlnbm1lbnQiLCJ3cmFwVGV4dCIsInZlcnRpY2FsIiwiYm9va19hcHBlbmRfc2hlZXQiLCJ3cml0ZSIsImJvb2tUeXBlIiwiYm9va1NTVCIsInR5cGUiLCJibG9iIiwiQmxvYiIsImRvd25sb2FkRmlsZSIsIm1vZGFsIiwidCIsInN0YXR1cyIsIndpbmRvdyIsImZpbGVuYW1lIiwibmF2aWdhdG9yIiwibXNTYXZlQmxvYiIsImxpbmtFbGVtIiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50IiwidGFyZ2V0IiwiZG93bmxvYWQiLCJocmVmIiwiVVJMIiwiY3JlYXRlT2JqZWN0VVJMIiwiYm9keSIsImFwcGVuZENoaWxkIiwiY2xpY2siLCJyZW1vdmVDaGlsZCIsImNvbnNvbGUiLCJlcnJvciIsInJlcGxhY2VEb3VibGVRdW90YXRpb24iLCJ2YWwiLCJwYXJzZUNzdiIsImNvbnRlbnQiLCJsaXN0Iiwic3BsaXQiLCJmaWVsZHMiLCJyTGlzdCIsInNsaWNlIiwiciIsImNvbEluZGV4IiwiY2hlY2tJbXBvcnREYXRhIiwidGFibGVGaWVsZHMiLCJmaWVsZCIsImV2ZXJ5IiwiaW5jbHVkZXMiLCJpbXBvcnRYTFNYIiwiZmlsZSIsIl9pbXBvcnRSZXNvbHZlIiwiZmlsZVJlYWRlciIsIkZpbGVSZWFkZXIiLCJvbmxvYWQiLCJlIiwid29ya2Jvb2siLCJyZWFkIiwicmVzdWx0IiwiY3N2RGF0YSIsInNoZWV0X3RvX2NzdiIsIlNoZWV0cyIsIlNoZWV0MSIsImNyZWF0ZURhdGEiLCJ0aGVuIiwiZGF0YSIsIm1vZGUiLCJpbnNlcnRBdCIsInJlbG9hZERhdGEiLCJ0ZW1wbGF0ZSIsInJlYWRBc0JpbmFyeVN0cmluZyIsImhhbmRsZUltcG9ydEV2ZW50IiwiaGFuZGxlRXhwb3J0RXZlbnQiLCJWWEVUYWJsZVBsdWdpbkV4cG9ydFhMU1giLCJpbnN0YWxsIiwieHRhYmxlIiwiaW50ZXJjZXB0b3IiLCJhc3NpZ24iLCJ0eXBlcyIsInhsc3giLCJtaXhpbiIsIlZYRVRhYmxlIiwidXNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQ0E7QUFVQTtBQUFxQztBQUFBO0FBQUE7QUFYckM7O0FBVUE7O0FBRUE7QUFFQSxJQUFJQSxTQUEwQjtBQUU5QixTQUFTQyxZQUFZLENBQUVDLE1BQW9CLEVB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QzlCLElBQVFDLFdBQVcsR0FBS0QsTUFBTSxDQUF0QkMsV0FBVztJQUNuQnhKLFNBQVMsR0FBR3VKLE1BQU07SUFDbEI5RixNQUFNLENBQUNnRyxNQUFNLENBQUNGLE1BQU0sQ0FBQ0csS0FBSyxFQUFFO01BQUVDLElBQUksRUFBRTtJQUFDLENBQUUsQ0FBQztJQUN4Q0gsV0FBVyxDQUFDSSxLQUFLLENBQUM7TUFDaEIsY0FBYyxFQUFFVCxpQkFBaUI7TUFDakMsY0FBYyxFQUFFQztJQ25CZCxDRG9CSCxDQUFDO0VBQ0o7QUNuQkYsQ0RvQkM7QUFBQTtBQUVELElBQUksT0FBT3pELE1BQU0sS0FBSyxXQUFXLElBQUlBLE1BQU0sQ0FBQ2tFLFFBQVEsRUFBRTtFQUNwRGxFLE1BQU0sQ0FBQ2tFLFFBQVEsQ0FBQ0MsR0FBRyxDQUFDVCx3QkFBd0IsQ0FBQztBQ3BCL0M7QURxQkMsZUFFY0Esd0JBQXdCO0FBQUEiLCJmaWxlIjoiaW5kZXguY29tbW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tdW51c2VkLXZhcnMgKi9cclxuaW1wb3J0IFhFVXRpbHMgZnJvbSAneGUtdXRpbHMvbWV0aG9kcy94ZS11dGlscydcclxuaW1wb3J0IHtcclxuICBWWEVUYWJsZSxcclxuICBUYWJsZSxcclxuICBJbnRlcmNlcHRvckV4cG9ydFBhcmFtcyxcclxuICBJbnRlcmNlcHRvckltcG9ydFBhcmFtcyxcclxuICBDb2x1bW5Db25maWcsXHJcbiAgRXhwb3J0T3B0b25zXHJcbn0gZnJvbSAndnhlLXRhYmxlL2xpYi92eGUtdGFibGUnXHJcbi8vIGltcG9ydCBYTFNYIGZyb20gJ3hsc3gnXHJcbmltcG9ydCAqIGFzIFhMU1ggZnJvbSAneGxzeC1qcy1zdHlsZSdcclxuLyogZXNsaW50LWVuYWJsZSBuby11bnVzZWQtdmFycyAqL1xyXG5cclxubGV0IF92eGV0YWJsZTogdHlwZW9mIFZYRVRhYmxlXHJcblxyXG5mdW5jdGlvbiBnZXRDZWxsTGFiZWwgKGNvbHVtbjogQ29sdW1uQ29uZmlnLCBjZWxsVmFsdWU6IGFueSkge1xyXG4gIGlmIChjZWxsVmFsdWUpIHtcclxuICAgIHN3aXRjaCAoY29sdW1uLmNlbGxUeXBlKSB7XHJcbiAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgcmV0dXJuIFhFVXRpbHMudG9TdHJpbmcoY2VsbFZhbHVlKVxyXG4gICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgIGlmICghaXNOYU4oY2VsbFZhbHVlKSkge1xyXG4gICAgICAgICAgcmV0dXJuIE51bWJlcihjZWxsVmFsdWUpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGJyZWFrXHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgaWYgKGNlbGxWYWx1ZS5sZW5ndGggPCAxMiAmJiAhaXNOYU4oY2VsbFZhbHVlKSkge1xyXG4gICAgICAgICAgcmV0dXJuIE51bWJlcihjZWxsVmFsdWUpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGJyZWFrXHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBjZWxsVmFsdWVcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0Rm9vdGVyQ2VsbFZhbHVlICgkdGFibGU6IFRhYmxlLCBvcHRzOiBFeHBvcnRPcHRvbnMsIHJvd3M6IGFueVtdLCBjb2x1bW46IENvbHVtbkNvbmZpZykge1xyXG4gIHZhciBjZWxsVmFsdWUgPSBYRVV0aWxzLnRvU3RyaW5nKHJvd3NbJHRhYmxlLiRnZXRDb2x1bW5JbmRleChjb2x1bW4pXSlcclxuICByZXR1cm4gY2VsbFZhbHVlXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRvQnVmZmVyICh3Ym91dDogYW55KSB7XHJcbiAgbGV0IGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcih3Ym91dC5sZW5ndGgpXHJcbiAgbGV0IHZpZXcgPSBuZXcgVWludDhBcnJheShidWYpXHJcbiAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCAhPT0gd2JvdXQubGVuZ3RoOyArK2luZGV4KSB2aWV3W2luZGV4XSA9IHdib3V0LmNoYXJDb2RlQXQoaW5kZXgpICYgMHhGRlxyXG4gIHJldHVybiBidWZcclxufVxyXG5cclxuZnVuY3Rpb24gZXhwb3J0WExTWCAocGFyYW1zOiBJbnRlcmNlcHRvckV4cG9ydFBhcmFtcykge1xyXG4gIGNvbnN0IHsgJHRhYmxlLCBvcHRpb25zLCBjb2x1bW5zLCBkYXRhcyB9ID0gcGFyYW1zXHJcbiAgY29uc3QgeyBzaGVldE5hbWUsIGlzSGVhZGVyLCBpc0Zvb3Rlciwgb3JpZ2luYWwsIG1lc3NhZ2UsIGZvb3RlckZpbHRlck1ldGhvZCB9ID0gb3B0aW9uc1xyXG4gIGNvbnN0IGNvbEhlYWQ6IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fVxyXG4gIGNvbnN0IGZvb3RMaXN0OiB7IFtrZXk6IHN0cmluZ106IGFueSB9W10gPSBbXVxyXG4gIC8vIGNvbnN0IHJvd0xpc3QgPSBkYXRhc1xyXG5cclxuICBpZiAoaXNIZWFkZXIpIHtcclxuICAgIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uKSA9PiB7XHJcbiAgICAgIGNvbEhlYWRbY29sdW1uLmlkXSA9IFhFVXRpbHMudG9TdHJpbmcob3JpZ2luYWwgPyBjb2x1bW4ucHJvcGVydHkgOiBjb2x1bW4uZ2V0VGl0bGUoKSlcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICAvLyDmlrDlop7pg6jliIZcclxuICBjb25zdCByb3dMaXN0ID0gZGF0YXMubWFwKGl0ZW0gPT4ge1xyXG4gICAgY29uc3QgcmVzdDogYW55ID0ge31cclxuICAgIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uKSA9PiB7XHJcbiAgICAgIHJlc3RbY29sdW1uLmlkXSA9IGdldENlbGxMYWJlbChjb2x1bW4sIGl0ZW1bY29sdW1uLmlkXSlcclxuICAgIH0pXHJcbiAgICByZXR1cm4gcmVzdFxyXG4gIH0pXHJcblxyXG4gIGlmIChpc0Zvb3Rlcikge1xyXG4gICAgY29uc3QgeyBmb290ZXJEYXRhIH0gPSAkdGFibGUuZ2V0VGFibGVEYXRhKClcclxuICAgIGNvbnN0IGZvb3RlcnMgPSBmb290ZXJGaWx0ZXJNZXRob2QgPyBmb290ZXJEYXRhLmZpbHRlcihmb290ZXJGaWx0ZXJNZXRob2QpIDogZm9vdGVyRGF0YVxyXG4gICAgZm9vdGVycy5mb3JFYWNoKChyb3dzKSA9PiB7XHJcbiAgICAgIGNvbnN0IGl0ZW06IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fVxyXG4gICAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbikgPT4ge1xyXG4gICAgICAgIGl0ZW1bY29sdW1uLmlkXSA9IGdldEZvb3RlckNlbGxWYWx1ZSgkdGFibGUsIG9wdGlvbnMsIHJvd3MsIGNvbHVtbilcclxuICAgICAgfSlcclxuICAgICAgZm9vdExpc3QucHVzaChpdGVtKVxyXG4gICAgfSlcclxuICB9XHJcbiAgY29uc3QgYm9vayA9IFhMU1gudXRpbHMuYm9va19uZXcoKVxyXG4gIGNvbnN0IHNoZWV0ID0gWExTWC51dGlscy5qc29uX3RvX3NoZWV0KChpc0hlYWRlciA/IFtjb2xIZWFkXSA6IFtdKS5jb25jYXQocm93TGlzdCkuY29uY2F0KGZvb3RMaXN0KSwgeyBza2lwSGVhZGVyOiB0cnVlIH0pXHJcblxyXG4gIE9iamVjdC5rZXlzKHNoZWV0KS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAvLyDpnZ4h5byA5aS055qE5bGe5oCn6YO95piv5Y2V5YWD5qC8XHJcbiAgICBpZiAoIWtleS5zdGFydHNXaXRoKCchJykpIHtcclxuICAgICAgaWYgKGtleS5yZXBsYWNlKC9bXlxcZF0vZywgJycpID09PSAnMScpIHtcclxuICAgICAgICBzaGVldFtrZXldLnYgPSBzaGVldFtrZXldLnYucGFkRW5kKDEwLCAnICcpIC8vIOaJi+WKqOihpeS9jVxyXG4gICAgICAgIHNoZWV0W2tleV0ucyA9IHtcclxuICAgICAgICAgIGZvbnQ6IHtcclxuICAgICAgICAgICAgc3o6ICcxMCcsXHJcbiAgICAgICAgICAgIGJvbGQ6IHRydWVcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBmaWxsOiB7XHJcbiAgICAgICAgICAgIGZnQ29sb3I6IHsgcmdiOiAnRjJGMkYyJyB9XHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgYm9yZGVyOiB7XHJcbiAgICAgICAgICAgIHRvcDogeyBzdHlsZTogJ3RoaW4nIH0sXHJcbiAgICAgICAgICAgIHJpZ2h0OiB7IHN0eWxlOiAndGhpbicgfSxcclxuICAgICAgICAgICAgYm90dG9tOiB7IHN0eWxlOiAndGhpbicgfSxcclxuICAgICAgICAgICAgbGVmdDogeyBzdHlsZTogJ3RoaW4nIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgc2hlZXRba2V5XS5zID0ge1xyXG4gICAgICAgICAgZm9udDoge1xyXG4gICAgICAgICAgICBzejogJzEwJ1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIGFsaWdubWVudDoge1xyXG4gICAgICAgICAgICB3cmFwVGV4dDogdHJ1ZSxcclxuICAgICAgICAgICAgdmVydGljYWw6ICd0b3AnXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgYm9yZGVyOiB7XHJcbiAgICAgICAgICAgIHRvcDogeyBzdHlsZTogJ3RoaW4nIH0sXHJcbiAgICAgICAgICAgIHJpZ2h0OiB7IHN0eWxlOiAndGhpbicgfSxcclxuICAgICAgICAgICAgYm90dG9tOiB7IHN0eWxlOiAndGhpbicgfSxcclxuICAgICAgICAgICAgbGVmdDogeyBzdHlsZTogJ3RoaW4nIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9KVxyXG5cclxuICAvLyDovazmjaLmlbDmja5cclxuICBYTFNYLnV0aWxzLmJvb2tfYXBwZW5kX3NoZWV0KGJvb2ssIHNoZWV0LCBzaGVldE5hbWUpXHJcbiAgY29uc3Qgd2JvdXQgPSBYTFNYLndyaXRlKGJvb2ssIHsgYm9va1R5cGU6ICd4bHN4JywgYm9va1NTVDogZmFsc2UsIHR5cGU6ICdiaW5hcnknIH0pXHJcbiAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFt0b0J1ZmZlcih3Ym91dCldLCB7IHR5cGU6ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nIH0pXHJcbiAgLy8g5L+d5a2Y5a+85Ye6XHJcbiAgZG93bmxvYWRGaWxlKGJsb2IsIG9wdGlvbnMpXHJcbiAgaWYgKG1lc3NhZ2UgIT09IGZhbHNlKSB7XHJcbiAgICBfdnhldGFibGUubW9kYWwubWVzc2FnZSh7IG1lc3NhZ2U6IF92eGV0YWJsZS50KCd2eGUudGFibGUuZXhwU3VjY2VzcycpLCBzdGF0dXM6ICdzdWNjZXNzJyB9KVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZG93bmxvYWRGaWxlIChibG9iOiBCbG9iLCBvcHRpb25zOiBFeHBvcnRPcHRvbnMpIHtcclxuICBpZiAod2luZG93LkJsb2IpIHtcclxuICAgIGNvbnN0IHsgZmlsZW5hbWUsIHR5cGUgfSA9IG9wdGlvbnNcclxuICAgIGlmIChuYXZpZ2F0b3IubXNTYXZlQmxvYikge1xyXG4gICAgICBuYXZpZ2F0b3IubXNTYXZlQmxvYihibG9iLCBgJHtmaWxlbmFtZX0uJHt0eXBlfWApXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB2YXIgbGlua0VsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJylcclxuICAgICAgbGlua0VsZW0udGFyZ2V0ID0gJ19ibGFuaydcclxuICAgICAgbGlua0VsZW0uZG93bmxvYWQgPSBgJHtmaWxlbmFtZX0uJHt0eXBlfWBcclxuICAgICAgbGlua0VsZW0uaHJlZiA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYilcclxuICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChsaW5rRWxlbSlcclxuICAgICAgbGlua0VsZW0uY2xpY2soKVxyXG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGxpbmtFbGVtKVxyXG4gICAgfVxyXG4gIH0gZWxzZSB7XHJcbiAgICBjb25zb2xlLmVycm9yKF92eGV0YWJsZS50KCd2eGUuZXJyb3Iubm90RXhwJykpXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiByZXBsYWNlRG91YmxlUXVvdGF0aW9uICh2YWw6IHN0cmluZykge1xyXG4gIHJldHVybiB2YWwucmVwbGFjZSgvXlwiLywgJycpLnJlcGxhY2UoL1wiJC8sICcnKVxyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZUNzdiAoY29sdW1uczogQ29sdW1uQ29uZmlnW10sIGNvbnRlbnQ6IHN0cmluZykge1xyXG4gIGNvbnN0IGxpc3QgPSBjb250ZW50LnNwbGl0KCdcXG4nKVxyXG4gIGNvbnN0IGZpZWxkczogc3RyaW5nW10gPSBbXVxyXG4gIGNvbnN0IHJvd3M6IGFueVtdID0gW11cclxuICBpZiAobGlzdC5sZW5ndGgpIHtcclxuICAgIGNvbnN0IHJMaXN0ID0gbGlzdC5zbGljZSgxKVxyXG4gICAgbGlzdFswXS5zcGxpdCgnLCcpLm1hcChyZXBsYWNlRG91YmxlUXVvdGF0aW9uKVxyXG4gICAgckxpc3QuZm9yRWFjaCgocikgPT4ge1xyXG4gICAgICBpZiAocikge1xyXG4gICAgICAgIGNvbnN0IGl0ZW06IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fVxyXG4gICAgICAgIHIuc3BsaXQoJywnKS5mb3JFYWNoKCh2YWwsIGNvbEluZGV4KSA9PiB7XHJcbiAgICAgICAgICBpZiAoZmllbGRzW2NvbEluZGV4XSkge1xyXG4gICAgICAgICAgICBpdGVtW2ZpZWxkc1tjb2xJbmRleF1dID0gcmVwbGFjZURvdWJsZVF1b3RhdGlvbih2YWwpXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgICByb3dzLnB1c2goaXRlbSlcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcbiAgcmV0dXJuIHsgZmllbGRzLCByb3dzIH1cclxufVxyXG5cclxuZnVuY3Rpb24gY2hlY2tJbXBvcnREYXRhIChjb2x1bW5zOiBDb2x1bW5Db25maWdbXSwgZmllbGRzOiBzdHJpbmdbXSwgcm93czogYW55W10pIHtcclxuICBsZXQgdGFibGVGaWVsZHM6IHN0cmluZ1tdID0gW11cclxuICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbikgPT4ge1xyXG4gICAgbGV0IGZpZWxkID0gY29sdW1uLnByb3BlcnR5XHJcbiAgICBpZiAoZmllbGQpIHtcclxuICAgICAgdGFibGVGaWVsZHMucHVzaChmaWVsZClcclxuICAgIH1cclxuICB9KVxyXG4gIHJldHVybiB0YWJsZUZpZWxkcy5ldmVyeSgoZmllbGQpID0+IGZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGltcG9ydFhMU1ggKHBhcmFtczogSW50ZXJjZXB0b3JJbXBvcnRQYXJhbXMpIHtcclxuICBjb25zdCB7IGNvbHVtbnMsIG9wdGlvbnMsIGZpbGUgfSA9IHBhcmFtc1xyXG4gIGNvbnN0ICR0YWJsZTogYW55ID0gcGFyYW1zLiR0YWJsZVxyXG4gIGNvbnN0IHsgX2ltcG9ydFJlc29sdmUgfSA9ICR0YWJsZVxyXG4gIGNvbnN0IGZpbGVSZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpXHJcbiAgZmlsZVJlYWRlci5vbmxvYWQgPSAoZTogYW55KSA9PiB7XHJcbiAgICBjb25zdCB3b3JrYm9vayA9IFhMU1gucmVhZChlLnRhcmdldC5yZXN1bHQsIHsgdHlwZTogJ2JpbmFyeScgfSlcclxuICAgIGNvbnN0IGNzdkRhdGE6IHN0cmluZyA9IFhMU1gudXRpbHMuc2hlZXRfdG9fY3N2KHdvcmtib29rLlNoZWV0cy5TaGVldDEpXHJcbiAgICBjb25zdCB7IGZpZWxkcywgcm93cyB9ID0gcGFyc2VDc3YoY29sdW1ucywgY3N2RGF0YSlcclxuICAgIGNvbnN0IHN0YXR1cyA9IGNoZWNrSW1wb3J0RGF0YShjb2x1bW5zLCBmaWVsZHMsIHJvd3MpXHJcbiAgICBpZiAoc3RhdHVzKSB7XHJcbiAgICAgICR0YWJsZS5jcmVhdGVEYXRhKHJvd3MpXHJcbiAgICAgICAgLnRoZW4oKGRhdGE6IGFueVtdKSA9PiB7XHJcbiAgICAgICAgICBpZiAob3B0aW9ucy5tb2RlID09PSAnYXBwZW5kJykge1xyXG4gICAgICAgICAgICAkdGFibGUuaW5zZXJ0QXQoZGF0YSwgLTEpXHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAkdGFibGUucmVsb2FkRGF0YShkYXRhKVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgIGlmIChvcHRpb25zLm1lc3NhZ2UgIT09IGZhbHNlKSB7XHJcbiAgICAgICAgX3Z4ZXRhYmxlLm1vZGFsLm1lc3NhZ2UoeyBtZXNzYWdlOiBYRVV0aWxzLnRlbXBsYXRlKF92eGV0YWJsZS50KCd2eGUudGFibGUuaW1wU3VjY2VzcycpLCBbcm93cy5sZW5ndGhdKSwgc3RhdHVzOiAnc3VjY2VzcycgfSlcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChvcHRpb25zLm1lc3NhZ2UgIT09IGZhbHNlKSB7XHJcbiAgICAgIF92eGV0YWJsZS5tb2RhbC5tZXNzYWdlKHsgbWVzc2FnZTogX3Z4ZXRhYmxlLnQoJ3Z4ZS5lcnJvci5pbXBGaWVsZHMnKSwgc3RhdHVzOiAnZXJyb3InIH0pXHJcbiAgICB9XHJcbiAgICBpZiAoX2ltcG9ydFJlc29sdmUpIHtcclxuICAgICAgX2ltcG9ydFJlc29sdmUoc3RhdHVzKVxyXG4gICAgICAkdGFibGUuX2ltcG9ydFJlc29sdmUgPSBudWxsXHJcbiAgICB9XHJcbiAgfVxyXG4gIGZpbGVSZWFkZXIucmVhZEFzQmluYXJ5U3RyaW5nKGZpbGUpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUltcG9ydEV2ZW50IChwYXJhbXM6IEludGVyY2VwdG9ySW1wb3J0UGFyYW1zKSB7XHJcbiAgaWYgKHBhcmFtcy5vcHRpb25zLnR5cGUgPT09ICd4bHN4Jykge1xyXG4gICAgaW1wb3J0WExTWChwYXJhbXMpXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUV4cG9ydEV2ZW50IChwYXJhbXM6IEludGVyY2VwdG9yRXhwb3J0UGFyYW1zKSB7XHJcbiAgaWYgKHBhcmFtcy5vcHRpb25zLnR5cGUgPT09ICd4bHN4Jykge1xyXG4gICAgZXhwb3J0WExTWChwYXJhbXMpXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDln7rkuo4gdnhlLXRhYmxlIOihqOagvOeahOWinuW8uuaPkuS7tu+8jOaUr+aMgeWvvOWHuiB4bHN4IOagvOW8j1xyXG4gKi9cclxuZXhwb3J0IGNvbnN0IFZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWCA9IHtcclxuICBpbnN0YWxsICh4dGFibGU6IHR5cGVvZiBWWEVUYWJsZSkge1xyXG4gICAgY29uc3QgeyBpbnRlcmNlcHRvciB9ID0geHRhYmxlXHJcbiAgICBfdnhldGFibGUgPSB4dGFibGVcclxuICAgIE9iamVjdC5hc3NpZ24oeHRhYmxlLnR5cGVzLCB7IHhsc3g6IDEgfSlcclxuICAgIGludGVyY2VwdG9yLm1peGluKHtcclxuICAgICAgJ2V2ZW50LmltcG9ydCc6IGhhbmRsZUltcG9ydEV2ZW50LFxyXG4gICAgICAnZXZlbnQuZXhwb3J0JzogaGFuZGxlRXhwb3J0RXZlbnRcclxuICAgIH0pXHJcbiAgfVxyXG59XHJcblxyXG5pZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LlZYRVRhYmxlKSB7XHJcbiAgd2luZG93LlZYRVRhYmxlLnVzZShWWEVUYWJsZVBsdWdpbkV4cG9ydFhMU1gpXHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IFZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWFxyXG4iLCIvKiBlc2xpbnQtZGlzYWJsZSBuby11bnVzZWQtdmFycyAqL1xuaW1wb3J0IFhFVXRpbHMgZnJvbSAneGUtdXRpbHMvbWV0aG9kcy94ZS11dGlscyc7XG4vLyBpbXBvcnQgWExTWCBmcm9tICd4bHN4J1xuaW1wb3J0ICogYXMgWExTWCBmcm9tICd4bHN4LWpzLXN0eWxlJztcbi8qIGVzbGludC1lbmFibGUgbm8tdW51c2VkLXZhcnMgKi9cbmxldCBfdnhldGFibGU7XG5mdW5jdGlvbiBnZXRDZWxsTGFiZWwoY29sdW1uLCBjZWxsVmFsdWUpIHtcbiAgICBpZiAoY2VsbFZhbHVlKSB7XG4gICAgICAgIHN3aXRjaCAoY29sdW1uLmNlbGxUeXBlKSB7XG4gICAgICAgICAgICBjYXNlICdzdHJpbmcnOlxuICAgICAgICAgICAgICAgIHJldHVybiBYRVV0aWxzLnRvU3RyaW5nKGNlbGxWYWx1ZSk7XG4gICAgICAgICAgICBjYXNlICdudW1iZXInOlxuICAgICAgICAgICAgICAgIGlmICghaXNOYU4oY2VsbFZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gTnVtYmVyKGNlbGxWYWx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICBpZiAoY2VsbFZhbHVlLmxlbmd0aCA8IDEyICYmICFpc05hTihjZWxsVmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBOdW1iZXIoY2VsbFZhbHVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGNlbGxWYWx1ZTtcbn1cbmZ1bmN0aW9uIGdldEZvb3RlckNlbGxWYWx1ZSgkdGFibGUsIG9wdHMsIHJvd3MsIGNvbHVtbikge1xuICAgIHZhciBjZWxsVmFsdWUgPSBYRVV0aWxzLnRvU3RyaW5nKHJvd3NbJHRhYmxlLiRnZXRDb2x1bW5JbmRleChjb2x1bW4pXSk7XG4gICAgcmV0dXJuIGNlbGxWYWx1ZTtcbn1cbmZ1bmN0aW9uIHRvQnVmZmVyKHdib3V0KSB7XG4gICAgbGV0IGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcih3Ym91dC5sZW5ndGgpO1xuICAgIGxldCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYnVmKTtcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4ICE9PSB3Ym91dC5sZW5ndGg7ICsraW5kZXgpXG4gICAgICAgIHZpZXdbaW5kZXhdID0gd2JvdXQuY2hhckNvZGVBdChpbmRleCkgJiAweEZGO1xuICAgIHJldHVybiBidWY7XG59XG5mdW5jdGlvbiBleHBvcnRYTFNYKHBhcmFtcykge1xuICAgIGNvbnN0IHsgJHRhYmxlLCBvcHRpb25zLCBjb2x1bW5zLCBkYXRhcyB9ID0gcGFyYW1zO1xuICAgIGNvbnN0IHsgc2hlZXROYW1lLCBpc0hlYWRlciwgaXNGb290ZXIsIG9yaWdpbmFsLCBtZXNzYWdlLCBmb290ZXJGaWx0ZXJNZXRob2QgfSA9IG9wdGlvbnM7XG4gICAgY29uc3QgY29sSGVhZCA9IHt9O1xuICAgIGNvbnN0IGZvb3RMaXN0ID0gW107XG4gICAgLy8gY29uc3Qgcm93TGlzdCA9IGRhdGFzXG4gICAgaWYgKGlzSGVhZGVyKSB7XG4gICAgICAgIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uKSA9PiB7XG4gICAgICAgICAgICBjb2xIZWFkW2NvbHVtbi5pZF0gPSBYRVV0aWxzLnRvU3RyaW5nKG9yaWdpbmFsID8gY29sdW1uLnByb3BlcnR5IDogY29sdW1uLmdldFRpdGxlKCkpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgLy8g5paw5aKe6YOo5YiGXG4gICAgY29uc3Qgcm93TGlzdCA9IGRhdGFzLm1hcChpdGVtID0+IHtcbiAgICAgICAgY29uc3QgcmVzdCA9IHt9O1xuICAgICAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbikgPT4ge1xuICAgICAgICAgICAgcmVzdFtjb2x1bW4uaWRdID0gZ2V0Q2VsbExhYmVsKGNvbHVtbiwgaXRlbVtjb2x1bW4uaWRdKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiByZXN0O1xuICAgIH0pO1xuICAgIGlmIChpc0Zvb3Rlcikge1xuICAgICAgICBjb25zdCB7IGZvb3RlckRhdGEgfSA9ICR0YWJsZS5nZXRUYWJsZURhdGEoKTtcbiAgICAgICAgY29uc3QgZm9vdGVycyA9IGZvb3RlckZpbHRlck1ldGhvZCA/IGZvb3RlckRhdGEuZmlsdGVyKGZvb3RlckZpbHRlck1ldGhvZCkgOiBmb290ZXJEYXRhO1xuICAgICAgICBmb290ZXJzLmZvckVhY2goKHJvd3MpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB7fTtcbiAgICAgICAgICAgIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uKSA9PiB7XG4gICAgICAgICAgICAgICAgaXRlbVtjb2x1bW4uaWRdID0gZ2V0Rm9vdGVyQ2VsbFZhbHVlKCR0YWJsZSwgb3B0aW9ucywgcm93cywgY29sdW1uKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgZm9vdExpc3QucHVzaChpdGVtKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGNvbnN0IGJvb2sgPSBYTFNYLnV0aWxzLmJvb2tfbmV3KCk7XG4gICAgY29uc3Qgc2hlZXQgPSBYTFNYLnV0aWxzLmpzb25fdG9fc2hlZXQoKGlzSGVhZGVyID8gW2NvbEhlYWRdIDogW10pLmNvbmNhdChyb3dMaXN0KS5jb25jYXQoZm9vdExpc3QpLCB7IHNraXBIZWFkZXI6IHRydWUgfSk7XG4gICAgT2JqZWN0LmtleXMoc2hlZXQpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgLy8g6Z2eIeW8gOWktOeahOWxnuaAp+mDveaYr+WNleWFg+agvFxuICAgICAgICBpZiAoIWtleS5zdGFydHNXaXRoKCchJykpIHtcbiAgICAgICAgICAgIGlmIChrZXkucmVwbGFjZSgvW15cXGRdL2csICcnKSA9PT0gJzEnKSB7XG4gICAgICAgICAgICAgICAgc2hlZXRba2V5XS52ID0gc2hlZXRba2V5XS52LnBhZEVuZCgxMCwgJyAnKTsgLy8g5omL5Yqo6KGl5L2NXG4gICAgICAgICAgICAgICAgc2hlZXRba2V5XS5zID0ge1xuICAgICAgICAgICAgICAgICAgICBmb250OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzejogJzEwJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvbGQ6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgZmlsbDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmdDb2xvcjogeyByZ2I6ICdGMkYyRjInIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b3A6IHsgc3R5bGU6ICd0aGluJyB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHQ6IHsgc3R5bGU6ICd0aGluJyB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgYm90dG9tOiB7IHN0eWxlOiAndGhpbicgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IHsgc3R5bGU6ICd0aGluJyB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgc2hlZXRba2V5XS5zID0ge1xuICAgICAgICAgICAgICAgICAgICBmb250OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzejogJzEwJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBhbGlnbm1lbnQ6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdyYXBUZXh0OiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmVydGljYWw6ICd0b3AnXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGJvcmRlcjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiB7IHN0eWxlOiAndGhpbicgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0OiB7IHN0eWxlOiAndGhpbicgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvdHRvbTogeyBzdHlsZTogJ3RoaW4nIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBsZWZ0OiB7IHN0eWxlOiAndGhpbicgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuICAgIC8vIOi9rOaNouaVsOaNrlxuICAgIFhMU1gudXRpbHMuYm9va19hcHBlbmRfc2hlZXQoYm9vaywgc2hlZXQsIHNoZWV0TmFtZSk7XG4gICAgY29uc3Qgd2JvdXQgPSBYTFNYLndyaXRlKGJvb2ssIHsgYm9va1R5cGU6ICd4bHN4JywgYm9va1NTVDogZmFsc2UsIHR5cGU6ICdiaW5hcnknIH0pO1xuICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbdG9CdWZmZXIod2JvdXQpXSwgeyB0eXBlOiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyB9KTtcbiAgICAvLyDkv53lrZjlr7zlh7pcbiAgICBkb3dubG9hZEZpbGUoYmxvYiwgb3B0aW9ucyk7XG4gICAgaWYgKG1lc3NhZ2UgIT09IGZhbHNlKSB7XG4gICAgICAgIF92eGV0YWJsZS5tb2RhbC5tZXNzYWdlKHsgbWVzc2FnZTogX3Z4ZXRhYmxlLnQoJ3Z4ZS50YWJsZS5leHBTdWNjZXNzJyksIHN0YXR1czogJ3N1Y2Nlc3MnIH0pO1xuICAgIH1cbn1cbmZ1bmN0aW9uIGRvd25sb2FkRmlsZShibG9iLCBvcHRpb25zKSB7XG4gICAgaWYgKHdpbmRvdy5CbG9iKSB7XG4gICAgICAgIGNvbnN0IHsgZmlsZW5hbWUsIHR5cGUgfSA9IG9wdGlvbnM7XG4gICAgICAgIGlmIChuYXZpZ2F0b3IubXNTYXZlQmxvYikge1xuICAgICAgICAgICAgbmF2aWdhdG9yLm1zU2F2ZUJsb2IoYmxvYiwgYCR7ZmlsZW5hbWV9LiR7dHlwZX1gKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHZhciBsaW5rRWxlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcbiAgICAgICAgICAgIGxpbmtFbGVtLnRhcmdldCA9ICdfYmxhbmsnO1xuICAgICAgICAgICAgbGlua0VsZW0uZG93bmxvYWQgPSBgJHtmaWxlbmFtZX0uJHt0eXBlfWA7XG4gICAgICAgICAgICBsaW5rRWxlbS5ocmVmID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobGlua0VsZW0pO1xuICAgICAgICAgICAgbGlua0VsZW0uY2xpY2soKTtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQobGlua0VsZW0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKF92eGV0YWJsZS50KCd2eGUuZXJyb3Iubm90RXhwJykpO1xuICAgIH1cbn1cbmZ1bmN0aW9uIHJlcGxhY2VEb3VibGVRdW90YXRpb24odmFsKSB7XG4gICAgcmV0dXJuIHZhbC5yZXBsYWNlKC9eXCIvLCAnJykucmVwbGFjZSgvXCIkLywgJycpO1xufVxuZnVuY3Rpb24gcGFyc2VDc3YoY29sdW1ucywgY29udGVudCkge1xuICAgIGNvbnN0IGxpc3QgPSBjb250ZW50LnNwbGl0KCdcXG4nKTtcbiAgICBjb25zdCBmaWVsZHMgPSBbXTtcbiAgICBjb25zdCByb3dzID0gW107XG4gICAgaWYgKGxpc3QubGVuZ3RoKSB7XG4gICAgICAgIGNvbnN0IHJMaXN0ID0gbGlzdC5zbGljZSgxKTtcbiAgICAgICAgbGlzdFswXS5zcGxpdCgnLCcpLm1hcChyZXBsYWNlRG91YmxlUXVvdGF0aW9uKTtcbiAgICAgICAgckxpc3QuZm9yRWFjaCgocikgPT4ge1xuICAgICAgICAgICAgaWYgKHIpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpdGVtID0ge307XG4gICAgICAgICAgICAgICAgci5zcGxpdCgnLCcpLmZvckVhY2goKHZhbCwgY29sSW5kZXgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkc1tjb2xJbmRleF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1bZmllbGRzW2NvbEluZGV4XV0gPSByZXBsYWNlRG91YmxlUXVvdGF0aW9uKHZhbCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByb3dzLnB1c2goaXRlbSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4geyBmaWVsZHMsIHJvd3MgfTtcbn1cbmZ1bmN0aW9uIGNoZWNrSW1wb3J0RGF0YShjb2x1bW5zLCBmaWVsZHMsIHJvd3MpIHtcbiAgICBsZXQgdGFibGVGaWVsZHMgPSBbXTtcbiAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbikgPT4ge1xuICAgICAgICBsZXQgZmllbGQgPSBjb2x1bW4ucHJvcGVydHk7XG4gICAgICAgIGlmIChmaWVsZCkge1xuICAgICAgICAgICAgdGFibGVGaWVsZHMucHVzaChmaWVsZCk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gdGFibGVGaWVsZHMuZXZlcnkoKGZpZWxkKSA9PiBmaWVsZHMuaW5jbHVkZXMoZmllbGQpKTtcbn1cbmZ1bmN0aW9uIGltcG9ydFhMU1gocGFyYW1zKSB7XG4gICAgY29uc3QgeyBjb2x1bW5zLCBvcHRpb25zLCBmaWxlIH0gPSBwYXJhbXM7XG4gICAgY29uc3QgJHRhYmxlID0gcGFyYW1zLiR0YWJsZTtcbiAgICBjb25zdCB7IF9pbXBvcnRSZXNvbHZlIH0gPSAkdGFibGU7XG4gICAgY29uc3QgZmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgZmlsZVJlYWRlci5vbmxvYWQgPSAoZSkgPT4ge1xuICAgICAgICBjb25zdCB3b3JrYm9vayA9IFhMU1gucmVhZChlLnRhcmdldC5yZXN1bHQsIHsgdHlwZTogJ2JpbmFyeScgfSk7XG4gICAgICAgIGNvbnN0IGNzdkRhdGEgPSBYTFNYLnV0aWxzLnNoZWV0X3RvX2Nzdih3b3JrYm9vay5TaGVldHMuU2hlZXQxKTtcbiAgICAgICAgY29uc3QgeyBmaWVsZHMsIHJvd3MgfSA9IHBhcnNlQ3N2KGNvbHVtbnMsIGNzdkRhdGEpO1xuICAgICAgICBjb25zdCBzdGF0dXMgPSBjaGVja0ltcG9ydERhdGEoY29sdW1ucywgZmllbGRzLCByb3dzKTtcbiAgICAgICAgaWYgKHN0YXR1cykge1xuICAgICAgICAgICAgJHRhYmxlLmNyZWF0ZURhdGEocm93cylcbiAgICAgICAgICAgICAgICAudGhlbigoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLm1vZGUgPT09ICdhcHBlbmQnKSB7XG4gICAgICAgICAgICAgICAgICAgICR0YWJsZS5pbnNlcnRBdChkYXRhLCAtMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAkdGFibGUucmVsb2FkRGF0YShkYXRhKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLm1lc3NhZ2UgIT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgX3Z4ZXRhYmxlLm1vZGFsLm1lc3NhZ2UoeyBtZXNzYWdlOiBYRVV0aWxzLnRlbXBsYXRlKF92eGV0YWJsZS50KCd2eGUudGFibGUuaW1wU3VjY2VzcycpLCBbcm93cy5sZW5ndGhdKSwgc3RhdHVzOiAnc3VjY2VzcycgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAob3B0aW9ucy5tZXNzYWdlICE9PSBmYWxzZSkge1xuICAgICAgICAgICAgX3Z4ZXRhYmxlLm1vZGFsLm1lc3NhZ2UoeyBtZXNzYWdlOiBfdnhldGFibGUudCgndnhlLmVycm9yLmltcEZpZWxkcycpLCBzdGF0dXM6ICdlcnJvcicgfSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKF9pbXBvcnRSZXNvbHZlKSB7XG4gICAgICAgICAgICBfaW1wb3J0UmVzb2x2ZShzdGF0dXMpO1xuICAgICAgICAgICAgJHRhYmxlLl9pbXBvcnRSZXNvbHZlID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH07XG4gICAgZmlsZVJlYWRlci5yZWFkQXNCaW5hcnlTdHJpbmcoZmlsZSk7XG59XG5mdW5jdGlvbiBoYW5kbGVJbXBvcnRFdmVudChwYXJhbXMpIHtcbiAgICBpZiAocGFyYW1zLm9wdGlvbnMudHlwZSA9PT0gJ3hsc3gnKSB7XG4gICAgICAgIGltcG9ydFhMU1gocGFyYW1zKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbn1cbmZ1bmN0aW9uIGhhbmRsZUV4cG9ydEV2ZW50KHBhcmFtcykge1xuICAgIGlmIChwYXJhbXMub3B0aW9ucy50eXBlID09PSAneGxzeCcpIHtcbiAgICAgICAgZXhwb3J0WExTWChwYXJhbXMpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxufVxuLyoqXG4gKiDln7rkuo4gdnhlLXRhYmxlIOihqOagvOeahOWinuW8uuaPkuS7tu+8jOaUr+aMgeWvvOWHuiB4bHN4IOagvOW8j1xuICovXG5leHBvcnQgY29uc3QgVlhFVGFibGVQbHVnaW5FeHBvcnRYTFNYID0ge1xuICAgIGluc3RhbGwoeHRhYmxlKSB7XG4gICAgICAgIGNvbnN0IHsgaW50ZXJjZXB0b3IgfSA9IHh0YWJsZTtcbiAgICAgICAgX3Z4ZXRhYmxlID0geHRhYmxlO1xuICAgICAgICBPYmplY3QuYXNzaWduKHh0YWJsZS50eXBlcywgeyB4bHN4OiAxIH0pO1xuICAgICAgICBpbnRlcmNlcHRvci5taXhpbih7XG4gICAgICAgICAgICAnZXZlbnQuaW1wb3J0JzogaGFuZGxlSW1wb3J0RXZlbnQsXG4gICAgICAgICAgICAnZXZlbnQuZXhwb3J0JzogaGFuZGxlRXhwb3J0RXZlbnRcbiAgICAgICAgfSk7XG4gICAgfVxufTtcbmlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuVlhFVGFibGUpIHtcbiAgICB3aW5kb3cuVlhFVGFibGUudXNlKFZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWCk7XG59XG5leHBvcnQgZGVmYXVsdCBWWEVUYWJsZVBsdWdpbkV4cG9ydFhMU1g7XG4iXX0=
